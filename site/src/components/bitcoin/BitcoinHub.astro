---
import CrossLinks from '@/components/CrossLinks.astro';
import FAQSection from '@/components/bitcoin/FAQSection.astro';
import QuizCTA from '@/components/bitcoin/QuizCTA.astro';
import QuizBitcoin from '@/components/tools/QuizBitcoin.tsx';
import { getLinksForBitcoinHub } from '@/data/internal-links';
import type { CollectionEntry } from 'astro:content';
import type { QuizData } from '@/data/bitcoin-quizzes';
import type { FAQItem } from '@/data/bitcoin-faqs';

interface Props {
  entry: CollectionEntry<'bitcoin'>;
  allPages: CollectionEntry<'bitcoin'>[];
  quizData?: QuizData | null;
  faqItems?: FAQItem[];
}

function entryIdToSlug(id: string): string {
  if (id === 'index') return '';
  if (id.endsWith('/index')) return id.slice(0, -'/index'.length);
  return id;
}

const { entry, allPages, quizData, faqItems = [] } = Astro.props;
const currentSlug = entryIdToSlug(entry.id);
const month = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

// Children of this branch hub
const children = allPages
  .filter(p => p.data.parent === currentSlug)
  .sort((a, b) => a.data.order - b.data.order);

// Breadcrumb
const crumbs = [
  { label: 'Accueil', href: '/' },
  { label: 'Bitcoin', href: '/bitcoin' },
  { label: entry.data.title, href: `/bitcoin/${currentSlug}` },
];

// Schema.org
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: crumbs.map((c, i) => ({
    '@type': 'ListItem',
    position: i + 1,
    name: c.label,
    item: `https://crypto-sous.fr${c.href}`,
  })),
};

const collectionPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: entry.data.title,
  description: entry.data.description,
  url: `https://crypto-sous.fr/bitcoin/${currentSlug}`,
  isPartOf: { '@type': 'WebSite', name: 'CryptoSous', url: 'https://crypto-sous.fr' },
};

const crossLinks = getLinksForBitcoinHub();
---

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Breadcrumb -->
  <nav class="flex items-center gap-2 text-sm text-text-muted mb-8 flex-wrap" aria-label="Fil d'ariane">
    {crumbs.map((crumb, i) => (
      <>
        {i > 0 && <span>/</span>}
        {i < crumbs.length - 1 ? (
          <a href={crumb.href} class="hover:text-gold transition-colors cursor-pointer">{crumb.label}</a>
        ) : (
          <span class="text-text-secondary">{crumb.label}</span>
        )}
      </>
    ))}
  </nav>

  <!-- Hero -->
  <header class="mb-12">
    <h1 class="font-display font-800 text-display leading-[1.1] mb-4 tracking-tight">
      {entry.data.title}
    </h1>
    <p class="text-body-lg text-text-secondary max-w-2xl">
      {entry.data.description}
    </p>
    <div class="mt-3">
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs border border-border text-text-muted">
        <span class="w-1.5 h-1.5 rounded-full bg-positive animate-pulse"></span>
        Mis Ã  jour en {month}
      </span>
    </div>
  </header>

  <!-- Quiz CTA -->
  {quizData && (
    <QuizCTA questionCount={quizData.questions.length} />
  )}

  <!-- Markdown content -->
  <div class="prose-custom mb-12">
    <slot />
  </div>

  <!-- Quiz -->
  {quizData && (
    <div id="quiz-section" class="scroll-mt-24 mb-12">
      <QuizBitcoin client:visible title={quizData.title} questions={quizData.questions} />
    </div>
  )}

  <!-- Child cards -->
  {children.length > 0 && (
    <section class="mb-12">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {children.map((child) => {
          const childSlug = entryIdToSlug(child.id);
          return (
            <a
              href={`/bitcoin/${childSlug}`}
              class="group flex flex-col p-5 rounded-xl border border-border bg-surface-raised/30 hover:border-gold/50 hover:bg-surface-hover transition-all duration-200 cursor-pointer"
            >
              <h3 class="font-display font-700 text-base mb-2 text-text-primary group-hover:text-gold transition-colors">
                {child.data.title}
              </h3>
              <p class="text-sm text-text-secondary line-clamp-2 flex-1 mb-3">
                {child.data.description}
              </p>
              <div class="flex items-center justify-end">
                <svg class="w-4 h-4 text-text-muted group-hover:text-gold transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>
          );
        })}
      </div>
    </section>
  )}

  <!-- Cross-linking -->
  <section class="mb-12">
    <h2 class="font-display font-700 text-h2 mb-6">Ressources complementaires</h2>
    <CrossLinks groups={crossLinks} title="Explorer aussi" />
  </section>

  <!-- FAQ -->
  {faqItems.length > 0 && (
    <FAQSection items={faqItems} />
  )}

  <!-- Disclaimer -->
  <div class="p-5 rounded-card border border-border bg-surface/50 text-xs text-text-muted leading-relaxed">
    <strong class="text-text-secondary">Avertissement :</strong> Les cryptomonnaies sont des actifs volatils. Investir comporte des risques de perte en capital. Ce guide ne constitue pas un conseil en investissement. Faites vos propres recherches (DYOR).
  </div>
</div>

<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
<script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
