---
import CrossLinks from '@/components/CrossLinks.astro';
import { getLinksForBitcoinHub } from '@/data/internal-links';
import type { CollectionEntry } from 'astro:content';

interface Props {
  entry: CollectionEntry<'bitcoin'>;
  allPages: CollectionEntry<'bitcoin'>[];
}

function entryIdToSlug(id: string): string {
  if (id === 'index') return '';
  if (id.endsWith('/index')) return id.slice(0, -'/index'.length);
  return id;
}

const { entry, allPages } = Astro.props;

const month = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

// Branch hubs (children of root)
const branches = allPages
  .filter(p => p.id !== 'index' && p.data.parent === null && p.data.type === 'hub')
  .sort((a, b) => a.data.order - b.data.order);

// Guides per branch
function getGuidesForBranch(branchSlug: string): CollectionEntry<'bitcoin'>[] {
  return allPages
    .filter(p => p.data.type === 'guide' && p.data.parent === branchSlug)
    .sort((a, b) => a.data.order - b.data.order);
}

// Branch metadata with editorial blurbs
const branchMeta: Record<string, { icon: string; accent: string; accentBg: string; blurb: string }> = {
  'bitcoin-debutant': {
    icon: 'üìñ',
    accent: 'border-info/40',
    accentBg: 'bg-info/5',
    blurb: "Vous d√©couvrez Bitcoin ? On reprend tout depuis le d√©but : ce que c'est, comment √ßa marche, et les erreurs classiques √† √©viter quand on d√©marre.",
  },
  'acheter-bitcoin': {
    icon: 'üí∞',
    accent: 'border-gold/40',
    accentBg: 'bg-gold/5',
    blurb: "Comparatif des plateformes, m√©thodes de paiement, frais cach√©s et tutoriels pas √† pas. Tout pour acheter vos premiers bitcoins en toute confiance.",
  },
  'vendre-bitcoin': {
    icon: 'üí∏',
    accent: 'border-positive/40',
    accentBg: 'bg-positive/5',
    blurb: "Convertir ses BTC en euros, envoyer du Bitcoin, payer en crypto : le guide complet pour utiliser et sortir de sa position.",
  },
  'comment-fonctionne-bitcoin': {
    icon: '‚öôÔ∏è',
    accent: 'border-violet/40',
    accentBg: 'bg-violet/5',
    blurb: "Blockchain, proof of work, halving, transactions, noeuds : les m√©canismes techniques de Bitcoin expliqu√©s de mani√®re accessible.",
  },
  'lightning-network-bitcoin': {
    icon: '‚ö°',
    accent: 'border-gold/40',
    accentBg: 'bg-gold/5',
    blurb: "Le r√©seau de paiement instantan√© de Bitcoin. Comment √ßa fonctionne, quels wallets utiliser, et pourquoi c'est un tournant pour l'adoption.",
  },
  'meilleurs-portefeuilles-bitcoin': {
    icon: 'üîê',
    accent: 'border-info/40',
    accentBg: 'bg-info/5',
    blurb: "Hardware wallets, logiciels, cold storage : quel portefeuille choisir pour s√©curiser vos bitcoins selon votre profil et votre montant.",
  },
  'miner-bitcoin': {
    icon: '‚õèÔ∏è',
    accent: 'border-gold/40',
    accentBg: 'bg-gold/5',
    blurb: "Le minage s√©curise Bitcoin et cr√©e de nouveaux BTC. Rentabilit√©, mat√©riel, consommation d'√©nergie : tout ce qu'il faut savoir en 2025.",
  },
  'securite-bitcoin': {
    icon: 'üõ°Ô∏è',
    accent: 'border-negative/40',
    accentBg: 'bg-negative/5',
    blurb: "Arnaques, phishing, seed phrase, h√©ritage crypto : prot√©gez vos bitcoins contre les menaces les plus courantes.",
  },
  'investir-bitcoin': {
    icon: 'üìà',
    accent: 'border-positive/40',
    accentBg: 'bg-positive/5',
    blurb: "DCA, cycles de march√©, comparaison avec l'or et la bourse, indicateurs on-chain : les strat√©gies pour investir dans Bitcoin.",
  },
  'reglementation-bitcoin': {
    icon: '‚öñÔ∏è',
    accent: 'border-border',
    accentBg: 'bg-surface-raised/50',
    blurb: "Fiscalit√© des plus-values, d√©claration aux imp√¥ts, cadre MiCA, KYC : ce que dit la loi en France et en Europe.",
  },
  'histoire-bitcoin': {
    icon: 'üèõÔ∏è',
    accent: 'border-violet/40',
    accentBg: 'bg-violet/5',
    blurb: "De la cr√©ation par Satoshi Nakamoto aux ETF spot en passant par Mt. Gox et le Pizza Day : les moments qui ont fa√ßonn√© Bitcoin.",
  },
};

// Stats
const totalGuides = allPages.filter(p => p.data.type === 'guide').length;
const totalBranches = branches.length;

const heroImage = entry.data.image || '';

// Schema.org
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Accueil', item: 'https://crypto-sous.fr/' },
    { '@type': 'ListItem', position: 2, name: 'Bitcoin', item: 'https://crypto-sous.fr/bitcoin' },
  ],
};

const collectionPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: entry.data.title,
  description: entry.data.description,
  url: 'https://crypto-sous.fr/bitcoin',
  isPartOf: { '@type': 'WebSite', name: 'CryptoSous', url: 'https://crypto-sous.fr' },
};

const crossLinks = getLinksForBitcoinHub();

// FAQ
const faqItems = [
  {
    question: "Qu'est-ce que le Bitcoin ?",
    answer: "Bitcoin est une monnaie num√©rique d√©centralis√©e cr√©√©e en 2009 par Satoshi Nakamoto. Elle permet d'envoyer de l'argent de pair √† pair, sans banque ni interm√©diaire, gr√¢ce √† la technologie blockchain. Son offre est limit√©e √† 21 millions d'unit√©s.",
  },
  {
    question: "Comment acheter du Bitcoin en France ?",
    answer: "En France, vous pouvez acheter du Bitcoin sur des plateformes r√©gul√©es comme Binance, Coinbase ou Kraken. Il suffit de cr√©er un compte, v√©rifier votre identit√© (KYC), d√©poser des euros par virement SEPA ou carte bancaire, puis passer un ordre d'achat. Vous pouvez acheter √† partir de quelques euros.",
  },
  {
    question: "Le Bitcoin est-il l√©gal en France ?",
    answer: "Oui, le Bitcoin est l√©gal en France. Sa d√©tention et son √©change sont encadr√©s par la r√©glementation europ√©enne MiCA. Les plus-values sont impos√©es au pr√©l√®vement forfaitaire unique (PFU) de 30 %, et les comptes sur des plateformes √©trang√®res doivent √™tre d√©clar√©s aux imp√¥ts.",
  },
  {
    question: "Combien faut-il investir dans le Bitcoin ?",
    answer: "Il n'y a pas de montant minimum obligatoire. Un bitcoin se divise en 100 millions de satoshis, ce qui permet d'en acheter pour quelques euros. La plupart des plateformes acceptent des ordres √† partir de 1 √† 10 euros. La strat√©gie DCA (investissement r√©gulier) est recommand√©e pour lisser la volatilit√©.",
  },
  {
    question: "Comment s√©curiser ses bitcoins ?",
    answer: "Pour s√©curiser vos bitcoins, utilisez un portefeuille personnel (wallet) plut√¥t que de les laisser sur une plateforme d'√©change. Les hardware wallets (Ledger, Trezor) offrent le meilleur niveau de s√©curit√©. Prot√©gez votre seed phrase (phrase de r√©cup√©ration) et activez l'authentification √† deux facteurs (2FA) sur tous vos comptes.",
  },
  {
    question: "Quelle est la diff√©rence entre Bitcoin et les autres cryptomonnaies ?",
    answer: "Bitcoin est la premi√®re et la plus grande cryptomonnaie par capitalisation. Contrairement √† la plupart des altcoins, Bitcoin a une offre strictement limit√©e (21 millions), un r√©seau tr√®s d√©centralis√© et le plus long historique de s√©curit√©. Les autres cryptos (Ethereum, Solana...) offrent des fonctionnalit√©s diff√©rentes comme les smart contracts.",
  },
];

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqItems.map(item => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
};

// Pre-compute branch data to avoid complex JSX nesting
const branchSections = branches.map((child, idx) => {
  const childSlug = entryIdToSlug(child.id);
  const meta = branchMeta[childSlug];
  const guides = getGuidesForBranch(childSlug);
  const shortTitle = child.data.title
    .replace(/^(Les meilleurs |L'histoire de |Comment fonctionne |R√©glementation et fiscalit√© du )/, '')
    .replace(/ :.*$/, '')
    .replace(/ en 2025$/, '');
  return { child, childSlug, meta, guides, shortTitle, idx };
});
---

<div>
  <!-- Breadcrumb -->
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <nav class="flex items-center gap-2 text-sm text-text-muted mb-8 flex-wrap" aria-label="Fil d'ariane">
      <a href="/" class="hover:text-gold transition-colors cursor-pointer">Accueil</a>
      <span>/</span>
      <span class="text-text-secondary">Bitcoin</span>
    </nav>
  </div>

  <!-- Hero -->
  <header class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
    <div class="grid lg:grid-cols-[1fr_400px] gap-10 items-center">
      <div>
        <h1 class="font-display font-800 text-4xl sm:text-5xl lg:text-6xl leading-[1.05] mb-5 tracking-tight">
          Le guide complet<br /><span class="text-gradient-gold">Bitcoin</span>
        </h1>
        <p class="text-lg text-text-secondary leading-relaxed max-w-xl mb-6">
          {entry.data.description}
        </p>
        <div class="flex flex-wrap items-center gap-3">
          <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs border border-border text-text-muted">
            <span class="w-1.5 h-1.5 rounded-full bg-positive animate-pulse"></span>
            Mis √† jour en {month}
          </span>
          <span class="px-3 py-1.5 rounded-full text-xs border border-gold/20 text-gold bg-gold/5 font-medium">
            {totalBranches} th√®mes
          </span>
          <span class="px-3 py-1.5 rounded-full text-xs border border-border text-text-muted">
            {totalGuides}+ guides
          </span>
        </div>
        <div class="mt-6">
          <a
            href="#section-bitcoin-debutant"
            class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-semibold bg-gold text-void rounded-lg hover:bg-gold-light transition-colors cursor-pointer"
          >
            Commencez ici
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </a>
        </div>
      </div>
      <div class:list={['rounded-2xl overflow-hidden border border-border hidden lg:block', { 'invisible': !heroImage }]}>
        <img
          src={heroImage || '/images/bitcoin/bitcoin-hub.webp'}
          alt={entry.data.title}
          class="w-full h-auto object-cover aspect-[4/3]"
          loading="eager"
        />
      </div>
    </div>
  </header>

  <!-- Mobile hero image -->
  <div class:list={['lg:hidden max-w-6xl mx-auto px-4 sm:px-6 mb-12', { hidden: !heroImage }]}>
    <div class="rounded-2xl overflow-hidden border border-border">
      <img
        src={heroImage || '/images/bitcoin/bitcoin-hub.webp'}
        alt={entry.data.title}
        class="w-full h-auto object-cover aspect-video"
        loading="eager"
      />
    </div>
  </div>

  <!-- Quick nav strip -->
  <div class="border-y border-border bg-surface-raised/20 mb-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex flex-wrap gap-2">
        {branchSections.map(({ childSlug, meta, shortTitle }) => (
          <a
            href={`#section-${childSlug}`}
            class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm border border-border text-text-secondary hover:border-gold/40 hover:text-gold hover:bg-gold/5 transition-all cursor-pointer"
          >
            <span class="text-sm">{meta?.icon}</span>
            {shortTitle}
          </a>
        ))}
      </div>
    </div>
  </div>

  <!-- Bitcoin en bref ‚Äî key takeaways box -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
    <div class="rounded-xl border border-gold/20 bg-gold/5 p-6 sm:p-8">
      <h2 class="font-display font-700 text-lg mb-4 text-gold">Bitcoin en bref</h2>
      <ul class="space-y-2.5 text-sm text-text-secondary leading-relaxed">
        <li class="flex gap-3"><span class="text-gold mt-0.5 shrink-0">&#x25B8;</span><span>Monnaie num√©rique cr√©√©e en 2009 par Satoshi Nakamoto, sans banque ni interm√©diaire</span></li>
        <li class="flex gap-3"><span class="text-gold mt-0.5 shrink-0">&#x25B8;</span><span>Offre limit√©e √† 21 millions d'unit√©s - un bitcoin se divise en 100 millions de satoshis</span></li>
        <li class="flex gap-3"><span class="text-gold mt-0.5 shrink-0">&#x25B8;</span><span>S√©curis√© par un r√©seau d√©centralis√© de milliers de noeuds et de mineurs</span></li>
        <li class="flex gap-3"><span class="text-gold mt-0.5 shrink-0">&#x25B8;</span><span>Plus de 200 millions d'utilisateurs dans le monde, adopt√© par des entreprises et des √âtats</span></li>
        <li class="flex gap-3"><span class="text-gold mt-0.5 shrink-0">&#x25B8;</span><span>S'ach√®te sur des plateformes comme Binance, Coinbase ou Kraken, √† partir de quelques euros</span></li>
      </ul>
    </div>
  </div>

  <!-- Editorial intro -->
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
    <div class="prose-custom text-lg">
      <slot />
    </div>
  </div>

  <!-- Branch sections -->
  <div class="space-y-0 mb-16">
    {branchSections.map(({ child, childSlug, meta, guides, idx }) => (
      <section
        id={`section-${childSlug}`}
        class:list={['scroll-mt-24 border-t border-border', { 'bg-surface-raised/10': idx % 2 === 1 }]}
      >
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <div class="grid lg:grid-cols-[1fr_1fr] gap-8 items-start">
            <div>
              <div class="flex items-center gap-3 mb-4">
                <span class="text-3xl">{meta?.icon}</span>
                <div>
                  <h2 class="font-display font-800 text-2xl sm:text-3xl tracking-tight">
                    {child.data.title}
                  </h2>
                  <span class="inline-block mt-1 text-xs text-text-muted">
                    {guides.length > 0 ? `${guides.length} guide${guides.length > 1 ? 's' : ''}` : 'Bient√¥t disponible'}
                  </span>
                </div>
              </div>
              <p class="text-text-secondary leading-relaxed mb-6 max-w-lg">
                {meta?.blurb || child.data.description}
              </p>
              <a
                href={`/bitcoin/${childSlug}`}
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium bg-gold/10 text-gold border border-gold/20 rounded-lg hover:bg-gold/20 transition-colors cursor-pointer"
              >
                Explorer cette section
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>

            <div>
              <div class:list={[{ hidden: guides.length === 0 }]}>
                <div class="space-y-2">
                  {guides.slice(0, 5).map((guide) => (
                    <a
                      href={`/bitcoin/${entryIdToSlug(guide.id)}`}
                      class="group flex items-center gap-3 p-3 rounded-lg border border-border/50 hover:border-gold/30 hover:bg-surface-hover/30 transition-all cursor-pointer"
                    >
                      <span class="text-sm text-text-secondary group-hover:text-text-primary transition-colors flex-1">
                        {guide.data.title}
                      </span>
                      {guide.data.readingTime && (
                        <span class="text-xs text-text-muted shrink-0">{guide.data.readingTime}</span>
                      )}
                      <svg class="w-3.5 h-3.5 text-text-muted group-hover:text-gold transition-colors shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                      </svg>
                    </a>
                  ))}
                </div>
              </div>
              <div class:list={[`rounded-xl ${meta?.accentBg || 'bg-surface-raised/30'} border ${meta?.accent || 'border-border'} p-6`, { hidden: guides.length > 0 }]}>
                <p class="text-sm text-text-muted leading-relaxed">
                  Guides en cours de r√©daction. Cette section sera bient√¥t compl√©t√©e avec des tutoriels d√©taill√©s et des comparatifs.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>
    ))}
  </div>

  <!-- Cross-linking -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-12">
    <h2 class="font-display font-700 text-h2 mb-6">Ressources compl√©mentaires</h2>
    <CrossLinks groups={crossLinks} title="Explorer aussi" />
  </div>

  <!-- FAQ -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-12">
    <h2 class="font-display font-700 text-h2 mb-6">Questions fr√©quentes sur le Bitcoin</h2>
    <div class="space-y-3">
      {faqItems.map((item) => (
        <details class="group rounded-xl border border-border bg-surface-raised/20 overflow-hidden">
          <summary class="flex items-center justify-between gap-4 px-5 py-4 cursor-pointer text-sm font-medium text-text-primary hover:text-gold transition-colors list-none [&::-webkit-details-marker]:hidden">
            <span>{item.question}</span>
            <svg class="w-4 h-4 shrink-0 text-text-muted transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <div class="px-5 pb-4 text-sm text-text-secondary leading-relaxed">
            {item.answer}
          </div>
        </details>
      ))}
    </div>
  </div>

  <!-- Disclaimer -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="p-5 rounded-card border border-border bg-surface/50 text-xs text-text-muted leading-relaxed">
      <strong class="text-text-secondary">Avertissement :</strong> Les cryptomonnaies sont des actifs volatils. Investir comporte des risques de perte en capital. Ce guide ne constitue pas un conseil en investissement. Faites vos propres recherches (DYOR).
    </div>
  </div>
</div>

<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
<script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
<script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
