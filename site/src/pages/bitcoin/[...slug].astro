---
import '@/styles/global.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
import Footer from '@/components/Footer.astro';
import BitcoinHubRoot from '@/components/bitcoin/BitcoinHubRoot.astro';
import BitcoinHub from '@/components/bitcoin/BitcoinHub.astro';
import BitcoinGuide from '@/components/bitcoin/BitcoinGuide.astro';
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { getQuizForSlug } from '@/data/bitcoin-quizzes';
import { getFaqForSlug } from '@/data/bitcoin-faqs';

export async function getStaticPaths() {
  const allPages = await getCollection('bitcoin');
  return allPages.map((entry) => {
    let slug = entry.id;
    if (slug === 'index') slug = '';
    else if (slug.endsWith('/index')) slug = slug.slice(0, -'/index'.length);
    return {
      params: { slug: slug || undefined },
      props: { entry, allPages },
    };
  });
}

interface Props {
  entry: CollectionEntry<'bitcoin'>;
  allPages: CollectionEntry<'bitcoin'>[];
}

const { entry, allPages } = Astro.props;
const { Content, headings } = await render(entry);
const isRootHub = entry.id === 'index';

// Compute lookup slug for quiz/FAQ data
const lookupSlug = entry.id === 'index' ? 'index' : entry.id.replace(/\/index$/, '');
const quizData = getQuizForSlug(lookupSlug);
const faqItems = getFaqForSlug(lookupSlug);
---

<BaseLayout
  title={`${entry.data.title} | CryptoSous`}
  description={entry.data.description}
  ogImage={entry.data.image}
>
  <Navbar />

  <main class="pt-32 pb-16">
    {isRootHub ? (
      <BitcoinHubRoot entry={entry} allPages={allPages} quizData={quizData} faqItems={faqItems}>
        <Content />
      </BitcoinHubRoot>
    ) : entry.data.type === 'hub' ? (
      <BitcoinHub entry={entry} allPages={allPages} quizData={quizData} faqItems={faqItems}>
        <Content />
      </BitcoinHub>
    ) : (
      <BitcoinGuide entry={entry} allPages={allPages} headings={headings} quizData={quizData} faqItems={faqItems}>
        <Content />
      </BitcoinGuide>
    )}
  </main>

  <Footer />
</BaseLayout>

<style is:global>
  .prose-custom h2 {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: var(--text-h3);
    margin-top: 2.5rem;
    margin-bottom: 0.75rem;
    color: var(--color-text-primary);
  }
  .prose-custom h3 {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 1.125rem;
    margin-top: 1.75rem;
    margin-bottom: 0.5rem;
    color: var(--color-text-primary);
  }
  .prose-custom p {
    color: var(--color-text-secondary);
    line-height: 1.75;
    margin-bottom: 1rem;
  }
  .prose-custom strong {
    color: var(--color-text-primary);
    font-weight: 600;
  }
  .prose-custom a {
    color: var(--color-gold);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .prose-custom a:hover {
    color: var(--color-gold-light);
  }
  .prose-custom ul, .prose-custom ol {
    color: var(--color-text-secondary);
    padding-left: 1.5rem;
    margin-bottom: 1rem;
  }
  .prose-custom li {
    margin-bottom: 0.5rem;
    line-height: 1.75;
  }
  .prose-custom blockquote {
    border-left: 3px solid var(--color-gold);
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: var(--color-text-secondary);
    font-style: italic;
  }
  .prose-custom hr {
    border-color: var(--color-border);
    margin: 2rem 0;
  }

  /* GitHub-style callout alerts */
  .prose-custom .markdown-alert {
    padding: 1rem 1.25rem;
    margin: 1.5rem 0;
    border-radius: 0.75rem;
    border-left: 4px solid;
  }
  .prose-custom .markdown-alert p {
    margin-bottom: 0.25rem;
  }
  .prose-custom .markdown-alert p:last-child {
    margin-bottom: 0;
  }
  .prose-custom .markdown-alert-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.5rem !important;
  }
  .prose-custom .markdown-alert-title .octicon {
    flex-shrink: 0;
  }

  /* TIP — gold */
  .prose-custom .markdown-alert-tip {
    background: rgba(245, 158, 11, 0.06);
    border-color: var(--color-gold);
  }
  .prose-custom .markdown-alert-tip .markdown-alert-title {
    color: var(--color-gold);
  }

  /* NOTE — blue */
  .prose-custom .markdown-alert-note {
    background: rgba(59, 130, 246, 0.06);
    border-color: #3b82f6;
  }
  .prose-custom .markdown-alert-note .markdown-alert-title {
    color: #3b82f6;
  }

  /* WARNING — orange */
  .prose-custom .markdown-alert-warning {
    background: rgba(249, 115, 22, 0.06);
    border-color: #f97316;
  }
  .prose-custom .markdown-alert-warning .markdown-alert-title {
    color: #f97316;
  }

  /* CAUTION — red */
  .prose-custom .markdown-alert-caution {
    background: rgba(239, 68, 68, 0.06);
    border-color: #ef4444;
  }
  .prose-custom .markdown-alert-caution .markdown-alert-title {
    color: #ef4444;
  }

  /* IMPORTANT — violet */
  .prose-custom .markdown-alert-important {
    background: rgba(139, 92, 246, 0.06);
    border-color: var(--color-violet);
  }
  .prose-custom .markdown-alert-important .markdown-alert-title {
    color: var(--color-violet);
  }

  /* SVG icon fill inherits title color */
  .prose-custom .markdown-alert-title .octicon path {
    fill: currentColor;
  }
  .prose-custom table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
    overflow-x: auto;
    display: block;
  }
  .prose-custom thead {
    background: rgba(245, 158, 11, 0.08);
  }
  .prose-custom th {
    color: var(--color-text-primary);
    font-weight: 600;
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid var(--color-gold);
    white-space: nowrap;
  }
  .prose-custom td {
    color: var(--color-text-secondary);
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
  }
  .prose-custom tbody tr:hover {
    background: rgba(245, 158, 11, 0.04);
  }

  /* Mermaid diagrams (scoped to avoid breaking callout octicons) */
  .prose-custom svg[id^="mermaid"] {
    max-width: 100%;
    height: auto;
    margin: 1.5rem auto;
    display: block;
  }
</style>
