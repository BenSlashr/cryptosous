---
import '@/styles/global.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
import Footer from '@/components/Footer.astro';
import ComparisonWidget from '@/components/tools/ComparisonWidget';
import {
  generateAllPairs,
  generateComparisonPage,
  getCoinSlug,
  POPULAR_PAIRS,
  CRYPTO_SPECS,
  type ComparisonPage,
} from '@/data/comparison-templates';
import CrossLinks from '@/components/CrossLinks.astro';
import { getLinksForComparisonPage, autoLink } from '@/data/internal-links';

export function getStaticPaths() {
  const pairs = generateAllPairs();
  return pairs.map(pair => {
    const page = generateComparisonPage(pair);
    return {
      params: { pair: pair.slug },
      props: { page },
    };
  });
}

interface Props {
  page: ComparisonPage;
}

const { page } = Astro.props;
const year = new Date().getFullYear();
const month = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

// Related comparisons (other pairs involving either crypto)
const allPairs = generateAllPairs();
const relatedPairs = allPairs
  .filter(p => p.slug !== page.slug && (p.coinA === page.coinIdA || p.coinA === page.coinIdB || p.coinB === page.coinIdA || p.coinB === page.coinIdB))
  .slice(0, 6);
const crossLinkGroups = getLinksForComparisonPage(
  page.coinIdA, page.coinIdB,
  page.specA.name, page.specB.name,
  page.specA.category, page.specB.category,
);
const currentPath = `/comparer/${page.slug}`;
---

<BaseLayout title={page.metaTitle} description={page.metaDescription}>
  <Navbar />

  <main class="pt-32 pb-16">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-text-muted mb-8" aria-label="Fil d'ariane">
        <a href="/" class="hover:text-gold transition-colors cursor-pointer">Accueil</a>
        <span>/</span>
        <a href="/comparer" class="hover:text-gold transition-colors cursor-pointer">Comparer</a>
        <span>/</span>
        <span class="text-text-secondary">{page.specA.name} vs {page.specB.name}</span>
      </nav>

      <!-- H1 -->
      <div class="mb-6">
        <h1 class="font-display font-800 text-display leading-[1.1] mb-4 tracking-tight">
          <span class="text-gradient-gold">{page.specA.name}</span>
          <span class="text-text-muted mx-2">vs</span>
          <span class="text-gradient-gold">{page.specB.name}</span>
        </h1>
        <p class="text-body-lg text-text-secondary max-w-xl">
          Comparatif détaillé {page.specA.symbol}/{page.specB.symbol} — Cours en direct, analyse technique et perspective investissement.
        </p>
        <div class="mt-3">
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs border border-border text-text-muted">
            <span class="w-1.5 h-1.5 rounded-full bg-positive animate-pulse"></span>
            Mis à jour en {month}
          </span>
        </div>
      </div>

      <!-- Key Takeaways -->
      <div class="mb-10 p-5 rounded-card border border-gold/20 bg-gold/5">
        <h2 class="font-display font-700 text-sm text-gold mb-3 uppercase tracking-wider">Points clés</h2>
        <ul class="space-y-2">
          {page.keyTakeaways.map((point) => (
            <li class="flex items-start gap-2 text-sm text-text-secondary leading-relaxed">
              <span class="w-1.5 h-1.5 rounded-full bg-gold mt-2 flex-shrink-0"></span>
              {point}
            </li>
          ))}
        </ul>
      </div>

      <!-- Interactive Widget -->
      <ComparisonWidget
        client:load
        coinIdA={page.coinIdA}
        coinIdB={page.coinIdB}
        nameA={page.specA.name}
        nameB={page.specB.name}
        symbolA={page.specA.symbol}
        symbolB={page.specB.symbol}
      />

      <!-- Technical Comparison Table -->
      <section class="mt-12">
        <h2 class="font-display font-700 text-h2 mb-6">
          Tableau comparatif technique
        </h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm border-collapse">
            <thead>
              <tr class="border-b border-border">
                <th class="text-left py-3 px-4 text-text-muted font-medium text-xs uppercase tracking-wider">Critère</th>
                <th class="text-left py-3 px-4 text-gold font-display font-bold">{page.specA.name} ({page.specA.symbol})</th>
                <th class="text-left py-3 px-4 text-violet font-display font-bold">{page.specB.name} ({page.specB.symbol})</th>
              </tr>
            </thead>
            <tbody>
              {page.techComparison.map((row) => (
                <tr class="border-b border-border/50 hover:bg-surface-hover/30 transition-colors">
                  <td class="py-3 px-4 text-text-secondary font-medium">{row.label}</td>
                  <td class="py-3 px-4 font-mono text-text-primary">
                    {row.coinA}
                    {row.winner === 'a' && <span class="ml-2 inline-block w-2 h-2 rounded-full bg-gold" title="Avantage"></span>}
                  </td>
                  <td class="py-3 px-4 font-mono text-text-primary">
                    {row.coinB}
                    {row.winner === 'b' && <span class="ml-2 inline-block w-2 h-2 rounded-full bg-violet" title="Avantage"></span>}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        <p class="mt-3 text-xs text-text-muted">
          <span class="inline-block w-2 h-2 rounded-full bg-gold mr-1 align-middle"></span> Avantage {page.specA.name}
          <span class="inline-block w-2 h-2 rounded-full bg-violet mr-1 ml-4 align-middle"></span> Avantage {page.specB.name}
        </p>
      </section>

      <!-- What is Coin A -->
      <section class="mt-12">
        <h2 class="font-display font-700 text-h2 mb-4">
          C'est quoi {page.specA.name} ({page.specA.symbol}) ?
        </h2>
        <p class="text-text-secondary leading-relaxed whitespace-pre-line" set:html={autoLink(page.whatIsA, currentPath)} />
      </section>

      <!-- What is Coin B -->
      <section class="mt-10">
        <h2 class="font-display font-700 text-h2 mb-4">
          C'est quoi {page.specB.name} ({page.specB.symbol}) ?
        </h2>
        <p class="text-text-secondary leading-relaxed whitespace-pre-line" set:html={autoLink(page.whatIsB, currentPath)} />
      </section>

      <!-- Use Cases -->
      <section class="mt-10">
        <h2 class="font-display font-700 text-h2 mb-4">
          Cas d'usage comparés
        </h2>
        <p class="text-text-secondary leading-relaxed whitespace-pre-line" set:html={autoLink(page.useCases, currentPath)} />
      </section>

      <!-- Investment Angle -->
      <section class="mt-10">
        <h2 class="font-display font-700 text-h2 mb-4">
          Perspective investissement {year}
        </h2>
        <p class="text-text-secondary leading-relaxed whitespace-pre-line" set:html={autoLink(page.investmentAngle, currentPath)} />
      </section>

      <!-- Verdict -->
      <section class="mt-10">
        <h2 class="font-display font-700 text-h2 mb-4">
          Verdict : {page.specA.name} ou {page.specB.name} ?
        </h2>
        <p class="text-text-secondary leading-relaxed whitespace-pre-line" set:html={autoLink(page.verdict, currentPath)} />
      </section>

      <!-- FAQ -->
      <section class="mt-16">
        <h2 class="font-display font-700 text-h2 mb-8">Questions fréquentes</h2>
        <div class="space-y-4">
          {page.faq.map((item) => (
            <details class="group rounded-card border border-border bg-surface-raised/30 overflow-hidden">
              <summary class="flex items-center justify-between p-5 cursor-pointer text-text-primary font-medium hover:text-gold transition-colors">
                {item.q}
                <svg class="w-5 h-5 text-text-muted group-open:rotate-180 transition-transform flex-shrink-0 ml-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="px-5 pb-5 text-sm text-text-secondary leading-relaxed">
                {item.a}
              </div>
            </details>
          ))}
        </div>
      </section>

      <!-- Internal linking: price pages -->
      <section class="mt-16">
        <h2 class="font-display font-700 text-h2 mb-6">Pages prix</h2>
        <div class="grid grid-cols-2 gap-3">
          <a
            href={`/prix/${page.coinIdA}`}
            class="flex flex-col items-center gap-2 p-4 rounded-xl border border-border bg-surface-raised/30 hover:border-gold/50 hover:bg-surface-hover transition-all cursor-pointer group text-center"
          >
            <span class="text-xs font-mono font-bold text-gold">{page.specA.symbol}</span>
            <span class="text-sm font-medium text-text-primary group-hover:text-gold transition-colors">Prix {page.specA.name}</span>
          </a>
          <a
            href={`/prix/${page.coinIdB}`}
            class="flex flex-col items-center gap-2 p-4 rounded-xl border border-border bg-surface-raised/30 hover:border-violet/50 hover:bg-surface-hover transition-all cursor-pointer group text-center"
          >
            <span class="text-xs font-mono font-bold text-violet">{page.specB.symbol}</span>
            <span class="text-sm font-medium text-text-primary group-hover:text-violet transition-colors">Prix {page.specB.name}</span>
          </a>
        </div>
      </section>

      <!-- Related comparisons -->
      {relatedPairs.length > 0 && (
        <section class="mt-10">
          <h2 class="font-display font-700 text-h2 mb-6">Autres comparaisons</h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            {relatedPairs.map((rp) => (
              <a
                href={`/comparer/${rp.slug}`}
                class="flex flex-col items-center gap-1 p-4 rounded-xl border border-border bg-surface-raised/30 hover:border-gold/50 hover:bg-surface-hover transition-all cursor-pointer group text-center"
              >
                <span class="text-xs font-mono text-text-muted">{rp.specA.symbol} vs {rp.specB.symbol}</span>
                <span class="text-sm font-medium text-text-primary group-hover:text-gold transition-colors">
                  {rp.specA.name} vs {rp.specB.name}
                </span>
              </a>
            ))}
          </div>
          <div class="mt-4">
            <a href="/comparer" class="text-sm text-gold hover:underline cursor-pointer">
              Voir toutes les comparaisons →
            </a>
          </div>
        </section>
      )}

      <!-- Cross-silo links -->
      <section class="mt-10">
        <CrossLinks groups={crossLinkGroups} />
      </section>

      <!-- Disclaimer -->
      <div class="mt-12 p-5 rounded-card border border-border bg-surface/50 text-xs text-text-muted leading-relaxed">
        <strong class="text-text-secondary">Avertissement :</strong> Les prix affichés proviennent de CoinGecko et représentent une moyenne pondérée sur les principales plateformes d'échange. Ce comparatif ne constitue pas un conseil en investissement. Les performances passées ne présagent pas des performances futures. Faites vos propres recherches (DYOR).
      </div>
    </div>
  </main>

  <Footer />

  <!-- Schema.org FAQPage -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": page.faq.map(item => ({
      "@type": "Question",
      "name": item.q,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": item.a,
      },
    })),
  })} />

  <!-- Schema.org BreadcrumbList -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Accueil", "item": "https://cryptosous.fr/" },
      { "@type": "ListItem", "position": 2, "name": "Comparer", "item": "https://cryptosous.fr/comparer" },
      { "@type": "ListItem", "position": 3, "name": `${page.specA.name} vs ${page.specB.name}` },
    ],
  })} />

  <!-- Schema.org Article -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": `${page.specA.name} vs ${page.specB.name} : Comparatif détaillé`,
    "description": page.metaDescription,
    "dateModified": new Date().toISOString().split('T')[0],
    "publisher": {
      "@type": "Organization",
      "name": "CryptoSous",
      "url": "https://cryptosous.fr",
    },
  })} />
</BaseLayout>
