---
import '@/styles/global.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
import Footer from '@/components/Footer.astro';
import ReviewScoreWidget from '@/components/tools/ReviewScoreWidget';
import ExchangeComparator from '@/components/tools/ExchangeComparator';
import DecisionTreeExchange from '@/components/tools/DecisionTreeExchange';
import { EXCHANGES, type ExchangeReview } from '@/data/exchange-reviews';
import CrossLinks from '@/components/CrossLinks.astro';
import { getLinksForExchangePage, autoLink } from '@/data/internal-links';

export function getStaticPaths() {
  return Object.values(EXCHANGES).map((ex) => ({
    params: { slug: ex.slug },
    props: { exchange: ex },
  }));
}

interface Props {
  exchange: ExchangeReview;
}

const { exchange } = Astro.props;
const year = new Date().getFullYear();
const month = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

const allExchangesForComparator = Object.values(EXCHANGES).map(e => ({
  slug: e.slug,
  name: e.name,
  fees: e.fees,
}));

const alternatives = exchange.alternatives
  .map(slug => EXCHANGES[slug])
  .filter(Boolean);
const crossLinkGroups = getLinksForExchangePage(exchange.slug);
const currentPath = `/plateformes/${exchange.slug}`;
---

<BaseLayout title={exchange.metaTitle} description={exchange.metaDescription}>
  <Navbar />

  <main class="pt-32 pb-16">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- 1. Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-text-muted mb-8" aria-label="Fil d'ariane">
        <a href="/" class="hover:text-gold transition-colors cursor-pointer">Accueil</a>
        <span>/</span>
        <a href="/plateformes" class="hover:text-gold transition-colors cursor-pointer">Plateformes</a>
        <span>/</span>
        <span class="text-text-secondary">{exchange.name}</span>
      </nav>

      <!-- 2. Hero -->
      <div class="mb-10">
        <div class="flex items-start gap-6 mb-4">
          <div class="flex-1">
            <h1 class="font-display font-800 text-display leading-[1.1] mb-3 tracking-tight">
              Avis <span class="text-gradient-gold">{exchange.name}</span> {year}
            </h1>
            <p class="text-body-lg text-text-secondary max-w-xl">
              {exchange.verdict}
            </p>
          </div>
          <div class="flex-shrink-0 hidden md:flex flex-col items-center gap-1">
            <div class="w-20 h-20 rounded-2xl border-2 border-gold/30 bg-gold/5 flex items-center justify-center">
              <span class="font-display font-800 text-2xl text-gold">{exchange.overallScore}</span>
            </div>
            <span class="text-xs text-text-muted">/ 10</span>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs border border-border text-text-muted">
            <span class="w-1.5 h-1.5 rounded-full bg-positive animate-pulse"></span>
            Mis à jour en {month}
          </span>
          <a
            href={exchange.affiliateUrl}
            class="inline-flex items-center gap-2 px-5 py-2 text-sm font-semibold bg-gold text-void rounded-lg hover:bg-gold-light transition-colors cursor-pointer"
          >
            Ouvrir un compte
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </div>

      <!-- 3. Quick Facts -->
      <div class="mb-10 grid grid-cols-2 sm:grid-cols-3 gap-4">
        {[
          { label: 'Fondé en', value: String(exchange.foundedYear) },
          { label: 'Siège', value: exchange.headquarters },
          { label: 'Régulation', value: exchange.regulation },
          { label: 'Cryptos', value: `${exchange.cryptosCount}+` },
          { label: 'Dépôt minimum', value: exchange.minDeposit },
          { label: 'App mobile', value: exchange.mobileApp ? 'Oui (iOS/Android)' : 'Non' },
        ].map((fact) => (
          <div class="p-4 rounded-xl border border-border bg-surface-raised/30">
            <p class="text-xs text-text-muted mb-1">{fact.label}</p>
            <p class="text-sm font-semibold text-text-primary">{fact.value}</p>
          </div>
        ))}
      </div>

      <!-- 4. Pros / Cons -->
      <div class="mb-10 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-5 rounded-xl border border-positive/20 bg-positive/5">
          <h2 class="font-display font-700 text-sm text-positive mb-3 uppercase tracking-wider">Avantages</h2>
          <ul class="space-y-2">
            {exchange.pros.map((pro) => (
              <li class="flex items-start gap-2 text-sm text-text-secondary leading-relaxed">
                <svg class="w-4 h-4 text-positive flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                {pro}
              </li>
            ))}
          </ul>
        </div>
        <div class="p-5 rounded-xl border border-negative/20 bg-negative/5">
          <h2 class="font-display font-700 text-sm text-negative mb-3 uppercase tracking-wider">Inconvénients</h2>
          <ul class="space-y-2">
            {exchange.cons.map((con) => (
              <li class="flex items-start gap-2 text-sm text-text-secondary leading-relaxed">
                <svg class="w-4 h-4 text-negative flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                {con}
              </li>
            ))}
          </ul>
        </div>
      </div>

      <!-- 5. Key Takeaways -->
      <div class="mb-10 p-5 rounded-card border border-gold/20 bg-gold/5">
        <h2 class="font-display font-700 text-sm text-gold mb-3 uppercase tracking-wider">Points clés</h2>
        <ul class="space-y-2">
          {exchange.keyTakeaways.map((point) => (
            <li class="flex items-start gap-2 text-sm text-text-secondary leading-relaxed">
              <span class="w-1.5 h-1.5 rounded-full bg-gold mt-2 flex-shrink-0"></span>
              {point}
            </li>
          ))}
        </ul>
      </div>

      <!-- 6. ReviewScoreWidget -->
      <div class="mb-10">
        <ReviewScoreWidget
          client:load
          overallScore={exchange.overallScore}
          criteria={exchange.ratings}
          productName={exchange.name}
        />
      </div>

      <!-- 7. ExchangeComparator -->
      <div class="mb-10">
        <ExchangeComparator
          client:load
          currentExchange={{
            slug: exchange.slug,
            name: exchange.name,
            fees: exchange.fees,
          }}
          allExchanges={allExchangesForComparator}
        />
      </div>

      <!-- 8. Editorial Sections -->
      {exchange.editorialSections.map((section) => (
        <section id={section.id} class="mt-10">
          <h2 class="font-display font-700 text-h2 mb-4">{section.title}</h2>
          <p class="text-text-secondary leading-relaxed whitespace-pre-line" set:html={autoLink(section.content, currentPath)} />
        </section>
      ))}

      <!-- 9. How to sign up -->
      <section class="mt-12">
        <h2 class="font-display font-700 text-h2 mb-6">Comment s'inscrire sur {exchange.name}</h2>
        <div class="space-y-4">
          {exchange.howToSteps.map((step, i) => (
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gold/10 border border-gold/30 flex items-center justify-center">
                <span class="font-display font-700 text-gold text-sm">{i + 1}</span>
              </div>
              <div>
                <h3 class="font-display font-600 text-text-primary mb-1">{step.title}</h3>
                <p class="text-sm text-text-secondary">{step.description}</p>
              </div>
            </div>
          ))}
        </div>
        <div class="mt-6">
          <a
            href={exchange.affiliateUrl}
            class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-semibold bg-gold text-void rounded-lg hover:bg-gold-light transition-colors cursor-pointer"
          >
            Ouvrir un compte {exchange.name}
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </section>

      <!-- 10. Alternatives -->
      {alternatives.length > 0 && (
        <section class="mt-12">
          <h2 class="font-display font-700 text-h2 mb-6">Alternatives à {exchange.name}</h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            {alternatives.map((alt) => (
              <a
                href={`/plateformes/${alt.slug}`}
                class="flex flex-col items-center gap-2 p-4 rounded-xl border border-border bg-surface-raised/30 hover:border-gold/50 hover:bg-surface-hover transition-all cursor-pointer group text-center"
              >
                <span class="text-lg font-display font-bold text-text-primary group-hover:text-gold transition-colors">{alt.name}</span>
                <span class="text-xs font-mono text-gold">{alt.overallScore}/10</span>
              </a>
            ))}
          </div>
          <div class="mt-4">
            <a href="/plateformes" class="text-sm text-gold hover:underline cursor-pointer">
              Voir toutes les plateformes →
            </a>
          </div>
        </section>
      )}

      <!-- Decision Tree -->
      <section class="mt-12">
        <DecisionTreeExchange client:visible />
      </section>

      <!-- Cross-silo links -->
      <section class="mt-10">
        <CrossLinks groups={crossLinkGroups} />
      </section>

      <!-- 11. FAQ -->
      <section class="mt-16">
        <h2 class="font-display font-700 text-h2 mb-8">Questions fréquentes</h2>
        <div class="space-y-4">
          {exchange.faq.map((item) => (
            <details class="group rounded-card border border-border bg-surface-raised/30 overflow-hidden">
              <summary class="flex items-center justify-between p-5 cursor-pointer text-text-primary font-medium hover:text-gold transition-colors">
                {item.q}
                <svg class="w-5 h-5 text-text-muted group-open:rotate-180 transition-transform flex-shrink-0 ml-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="px-5 pb-5 text-sm text-text-secondary leading-relaxed">
                {item.a}
              </div>
            </details>
          ))}
        </div>
      </section>

      <!-- 12. Verdict + CTA -->
      <section class="mt-12 p-6 rounded-xl border border-gold/20 bg-gold/5">
        <h2 class="font-display font-700 text-h2 mb-4">Verdict final — {exchange.name}</h2>
        <p class="text-text-secondary leading-relaxed mb-6">{exchange.verdict}</p>
        <a
          href={exchange.affiliateUrl}
          class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold bg-gold text-void rounded-lg hover:bg-gold-light transition-colors cursor-pointer"
        >
          Ouvrir un compte {exchange.name}
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      </section>

      <!-- 13. Disclaimer -->
      <div class="mt-12 p-5 rounded-card border border-border bg-surface/50 text-xs text-text-muted leading-relaxed">
        <strong class="text-text-secondary">Avertissement :</strong> Les cryptomonnaies sont des actifs volatils. Investir comporte des risques de perte en capital. Ce test ne constitue pas un conseil en investissement. Certains liens sont des liens d'affiliation : si vous ouvrez un compte, CryptoSous peut percevoir une commission sans surcoût pour vous. Cela n'influence pas notre notation. Faites vos propres recherches (DYOR).
      </div>
    </div>
  </main>

  <Footer />

  <!-- Schema.org Review -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Review",
    "name": `Avis ${exchange.name} ${year}`,
    "reviewBody": exchange.verdict,
    "dateModified": exchange.lastUpdated,
    "author": {
      "@type": "Organization",
      "name": "CryptoSous",
      "url": "https://cryptosous.fr",
    },
    "itemReviewed": {
      "@type": "SoftwareApplication",
      "name": exchange.name,
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web, iOS, Android",
    },
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": exchange.overallScore,
      "bestRating": 10,
      "worstRating": 0,
    },
  })} />

  <!-- Schema.org FAQPage -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": exchange.faq.map(item => ({
      "@type": "Question",
      "name": item.q,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": item.a,
      },
    })),
  })} />

  <!-- Schema.org BreadcrumbList -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Accueil", "item": "https://cryptosous.fr/" },
      { "@type": "ListItem", "position": 2, "name": "Plateformes", "item": "https://cryptosous.fr/plateformes" },
      { "@type": "ListItem", "position": 3, "name": exchange.name },
    ],
  })} />
</BaseLayout>
