---
import '@/styles/global.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
import Footer from '@/components/Footer.astro';
import ReviewScoreWidget from '@/components/tools/ReviewScoreWidget';
import WalletComparator from '@/components/tools/WalletComparator';
import DecisionTreeWallet from '@/components/tools/DecisionTreeWallet';
import { WALLETS, type WalletReview } from '@/data/wallet-reviews';
import CrossLinks from '@/components/CrossLinks.astro';
import { getLinksForWalletPage, autoLink } from '@/data/internal-links';

export function getStaticPaths() {
  return Object.values(WALLETS).map((w) => ({
    params: { slug: w.slug },
    props: { wallet: w },
  }));
}

interface Props {
  wallet: WalletReview;
}

const { wallet } = Astro.props;
const year = new Date().getFullYear();
const month = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

const allWalletsForComparator = Object.values(WALLETS).map(w => ({
  slug: w.slug,
  name: w.name,
  price: w.price,
  specs: w.specs,
  overallScore: w.overallScore,
}));

const alternatives = wallet.alternatives
  .map(slug => WALLETS[slug])
  .filter(Boolean);
const crossLinkGroups = getLinksForWalletPage(wallet.slug);
const currentPath = `/wallets/${wallet.slug}`;
---

<BaseLayout title={wallet.metaTitle} description={wallet.metaDescription}>
  <Navbar />

  <main class="pt-32 pb-16">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- 1. Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-text-muted mb-8" aria-label="Fil d'ariane">
        <a href="/" class="hover:text-gold transition-colors cursor-pointer">Accueil</a>
        <span>/</span>
        <a href="/wallets" class="hover:text-gold transition-colors cursor-pointer">Wallets</a>
        <span>/</span>
        <span class="text-text-secondary">{wallet.name}</span>
      </nav>

      <!-- 2. Hero -->
      <div class="mb-10">
        <div class="flex items-start gap-6 mb-4">
          <div class="flex-1">
            <p class="text-xs font-mono text-text-muted mb-2 uppercase tracking-wider">{wallet.brand}</p>
            <h1 class="font-display font-800 text-display leading-[1.1] mb-3 tracking-tight">
              Avis <span class="text-gradient-gold">{wallet.name}</span> {year}
            </h1>
            <p class="text-body-lg text-text-secondary max-w-xl">
              {wallet.verdict}
            </p>
          </div>
          <div class="flex-shrink-0 hidden md:flex flex-col items-center gap-2">
            <div class="w-20 h-20 rounded-2xl border-2 border-gold/30 bg-gold/5 flex items-center justify-center">
              <span class="font-display font-800 text-2xl text-gold">{wallet.overallScore}</span>
            </div>
            <span class="text-xs text-text-muted">/ 10</span>
            <span class="font-display font-700 text-gold text-lg">{wallet.price}</span>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs border border-border text-text-muted">
            <span class="w-1.5 h-1.5 rounded-full bg-positive animate-pulse"></span>
            Mis à jour en {month}
          </span>
          <span class="md:hidden font-display font-700 text-gold text-lg">{wallet.price}</span>
          <a
            href={wallet.affiliateUrl}
            class="inline-flex items-center gap-2 px-5 py-2 text-sm font-semibold bg-gold text-void rounded-lg hover:bg-gold-light transition-colors cursor-pointer"
          >
            Acheter sur {wallet.brand}
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </div>

      <!-- 3. Quick Specs -->
      <div class="mb-10 grid grid-cols-2 sm:grid-cols-3 gap-4">
        {[
          { label: 'Écran', value: wallet.specs.screen },
          { label: 'Connectivité', value: wallet.specs.connectivity.join(', ') },
          { label: 'Batterie', value: wallet.specs.battery ?? 'Non (USB)' },
          { label: 'Dimensions', value: wallet.specs.dimensions },
          { label: 'Poids', value: wallet.specs.weight },
          { label: 'Cryptos', value: `${wallet.specs.coinsSupported.toLocaleString('fr-FR')}+` },
        ].map((fact) => (
          <div class="p-4 rounded-xl border border-border bg-surface-raised/30">
            <p class="text-xs text-text-muted mb-1">{fact.label}</p>
            <p class="text-sm font-semibold text-text-primary">{fact.value}</p>
          </div>
        ))}
      </div>

      <!-- 4. Pros / Cons -->
      <div class="mb-10 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-5 rounded-xl border border-positive/20 bg-positive/5">
          <h2 class="font-display font-700 text-sm text-positive mb-3 uppercase tracking-wider">Avantages</h2>
          <ul class="space-y-2">
            {wallet.pros.map((pro) => (
              <li class="flex items-start gap-2 text-sm text-text-secondary leading-relaxed">
                <svg class="w-4 h-4 text-positive flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                {pro}
              </li>
            ))}
          </ul>
        </div>
        <div class="p-5 rounded-xl border border-negative/20 bg-negative/5">
          <h2 class="font-display font-700 text-sm text-negative mb-3 uppercase tracking-wider">Inconvénients</h2>
          <ul class="space-y-2">
            {wallet.cons.map((con) => (
              <li class="flex items-start gap-2 text-sm text-text-secondary leading-relaxed">
                <svg class="w-4 h-4 text-negative flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                {con}
              </li>
            ))}
          </ul>
        </div>
      </div>

      <!-- 5. Key Takeaways -->
      <div class="mb-10 p-5 rounded-card border border-gold/20 bg-gold/5">
        <h2 class="font-display font-700 text-sm text-gold mb-3 uppercase tracking-wider">Points clés</h2>
        <ul class="space-y-2">
          {wallet.keyTakeaways.map((point) => (
            <li class="flex items-start gap-2 text-sm text-text-secondary leading-relaxed">
              <span class="w-1.5 h-1.5 rounded-full bg-gold mt-2 flex-shrink-0"></span>
              {point}
            </li>
          ))}
        </ul>
      </div>

      <!-- 6. ReviewScoreWidget -->
      <div class="mb-10">
        <ReviewScoreWidget
          client:load
          overallScore={wallet.overallScore}
          criteria={wallet.ratings}
          productName={wallet.name}
        />
      </div>

      <!-- 7. WalletComparator -->
      <div class="mb-10">
        <WalletComparator
          client:load
          currentWallet={{
            slug: wallet.slug,
            name: wallet.name,
            price: wallet.price,
            specs: wallet.specs,
            overallScore: wallet.overallScore,
          }}
          allWallets={allWalletsForComparator}
        />
      </div>

      <!-- 8. Editorial Sections -->
      {wallet.editorialSections.map((section) => (
        <section id={section.id} class="mt-10">
          <h2 class="font-display font-700 text-h2 mb-4">{section.title}</h2>
          <p class="text-text-secondary leading-relaxed whitespace-pre-line" set:html={autoLink(section.content, currentPath)} />
        </section>
      ))}

      <!-- 9. Target Audience -->
      <section class="mt-12">
        <h2 class="font-display font-700 text-h2 mb-6">Pour qui est le {wallet.name} ?</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {wallet.targetAudience.map((audience) => (
            <div class={`p-4 rounded-xl border ${audience.recommended ? 'border-positive/20 bg-positive/5' : 'border-negative/20 bg-negative/5'}`}>
              <div class="flex items-center gap-2 mb-2">
                {audience.recommended ? (
                  <svg class="w-5 h-5 text-positive flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                ) : (
                  <svg class="w-5 h-5 text-negative flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                )}
                <h3 class="font-display font-600 text-sm text-text-primary">{audience.profile}</h3>
              </div>
              <p class="text-xs text-text-secondary leading-relaxed">{audience.reason}</p>
            </div>
          ))}
        </div>
      </section>

      <!-- 10. Alternatives -->
      {alternatives.length > 0 && (
        <section class="mt-12">
          <h2 class="font-display font-700 text-h2 mb-6">Alternatives au {wallet.name}</h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            {alternatives.map((alt) => (
              <a
                href={`/wallets/${alt.slug}`}
                class="flex flex-col items-center gap-2 p-4 rounded-xl border border-border bg-surface-raised/30 hover:border-gold/50 hover:bg-surface-hover transition-all cursor-pointer group text-center"
              >
                <span class="text-sm font-display font-bold text-text-primary group-hover:text-gold transition-colors">{alt.name}</span>
                <div class="flex items-center gap-2">
                  <span class="text-xs font-mono text-gold">{alt.overallScore}/10</span>
                  <span class="text-xs text-text-muted">·</span>
                  <span class="text-xs text-text-muted">{alt.price}</span>
                </div>
              </a>
            ))}
          </div>
          <div class="mt-4">
            <a href="/wallets" class="text-sm text-gold hover:underline cursor-pointer">
              Voir tous les wallets →
            </a>
          </div>
        </section>
      )}

      <!-- Decision Tree -->
      <section class="mt-12">
        <DecisionTreeWallet client:visible />
      </section>

      <!-- Cross-silo links -->
      <section class="mt-10">
        <CrossLinks groups={crossLinkGroups} />
      </section>

      <!-- 11. FAQ -->
      <section class="mt-16">
        <h2 class="font-display font-700 text-h2 mb-8">Questions fréquentes</h2>
        <div class="space-y-4">
          {wallet.faq.map((item) => (
            <details class="group rounded-card border border-border bg-surface-raised/30 overflow-hidden">
              <summary class="flex items-center justify-between p-5 cursor-pointer text-text-primary font-medium hover:text-gold transition-colors">
                {item.q}
                <svg class="w-5 h-5 text-text-muted group-open:rotate-180 transition-transform flex-shrink-0 ml-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="px-5 pb-5 text-sm text-text-secondary leading-relaxed">
                {item.a}
              </div>
            </details>
          ))}
        </div>
      </section>

      <!-- 12. Verdict + CTA -->
      <section class="mt-12 p-6 rounded-xl border border-gold/20 bg-gold/5">
        <h2 class="font-display font-700 text-h2 mb-4">Verdict final — {wallet.name}</h2>
        <p class="text-text-secondary leading-relaxed mb-6">{wallet.verdict}</p>
        <a
          href={wallet.affiliateUrl}
          class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold bg-gold text-void rounded-lg hover:bg-gold-light transition-colors cursor-pointer"
        >
          Acheter le {wallet.name} — {wallet.price}
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      </section>

      <!-- 13. Disclaimer -->
      <div class="mt-12 p-5 rounded-card border border-border bg-surface/50 text-xs text-text-muted leading-relaxed">
        <strong class="text-text-secondary">Avertissement :</strong> Les cryptomonnaies sont des actifs volatils. Investir comporte des risques de perte en capital. Ce test ne constitue pas un conseil en investissement. Certains liens sont des liens d'affiliation : si vous achetez via nos liens, CryptoSous peut percevoir une commission sans surcoût pour vous. Cela n'influence pas notre notation. Faites vos propres recherches (DYOR).
      </div>
    </div>
  </main>

  <Footer />

  <!-- Schema.org Review + Product -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Review",
    "name": `Avis ${wallet.name} ${year}`,
    "reviewBody": wallet.verdict,
    "dateModified": wallet.lastUpdated,
    "author": {
      "@type": "Organization",
      "name": "CryptoSous",
      "url": "https://cryptosous.fr",
    },
    "itemReviewed": {
      "@type": "Product",
      "name": wallet.name,
      "brand": { "@type": "Brand", "name": wallet.brand },
      "offers": {
        "@type": "Offer",
        "price": parseFloat(wallet.price.replace(/[^\d.]/g, '')),
        "priceCurrency": "EUR",
        "availability": "https://schema.org/InStock",
      },
    },
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": wallet.overallScore,
      "bestRating": 10,
      "worstRating": 0,
    },
  })} />

  <!-- Schema.org FAQPage -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": wallet.faq.map(item => ({
      "@type": "Question",
      "name": item.q,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": item.a,
      },
    })),
  })} />

  <!-- Schema.org BreadcrumbList -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Accueil", "item": "https://cryptosous.fr/" },
      { "@type": "ListItem", "position": 2, "name": "Wallets", "item": "https://cryptosous.fr/wallets" },
      { "@type": "ListItem", "position": 3, "name": wallet.name },
    ],
  })} />
</BaseLayout>
